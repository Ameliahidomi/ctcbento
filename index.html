<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å€‰åº«è¨‚é¤ç¶²</title>
<style>
:root{--page-width:900px;--bg:#fff4ea}
body{background:var(--bg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;color:#333;margin:0;display:flex;min-height:100vh;align-items:flex-start;justify-content:center;padding:40px 20px}
.container{width:100%;max-width:var(--page-width);background:white;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:24px;box-sizing:border-box}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
label{min-width:84px}
input[type=text],input[type=number]{padding:8px;border-radius:6px;border:1px solid #ddd}
select{padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:8px 12px;border-radius:8px;border:0;background:#ff8a4b;color:#fff;cursor:pointer}
button.secondary{background:#ffb777;color:#000}
.center{display:flex;justify-content:center;gap:12px;margin:16px 0}
.menu-area{border:1px dashed #ffd3b8;padding:12px;border-radius:8px;background:#fff7f0}
.hidden{display:none}

.order-item {
  position: relative;
  padding-right: 70px; /* é ç•™å³å´çµ¦åˆªé™¤æŒ‰éˆ• */
}

.order-item .delete-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: #ff6b6b;
  color: #fff;
  border: 0;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="container" role="application">
  <h1>å€‰åº«è¨‚é¤ç¶²</h1>

  <!-- Login page -->
  <div id="page-login">
    <div class="row">
      <label for="empId">å“¡å·¥å·¥è™Ÿ</label>
      <input id="empId" type="text" placeholder="è¼¸å…¥å·¥è™Ÿ (6ç¢¼)" />
    </div>
    <div class="center">
      <button id="btnLogin">ç™»å…¥</button>
    </div>
  </div>

  <!-- Home -->
  <div id="page-home" class="hidden">
    <p id="welcome"></p>
    <div class="center">
      <button id="toLunch">ğŸ±åˆé¤</button>
      <button id="toTea" class="secondary">â˜•ä¸‹åˆèŒ¶</button>
    </div>
  </div>

  <!-- Lunch -->
  <div id="page-lunch" class="hidden">
    <div class="row">
      <label for="restaurant">é¤å»³åç¨±</label>
      <select id="restaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>é¤é»é¸æ“‡</label>
        <select id="menuItem"></select>
      </div>

      <div class="row hidden" id="additionalRow">
        <label>è¾£åº¦</label>
        <select id="potMain"></select>
      </div>

      <div class="row">
        <label>èª¿å‘³</label>
        <select id="spice">
          <option>ä¸åŠ </option>
          <option>å¾®è¾£</option>
          <option>å°è¾£</option>
          <option>åŠ é†‹</option>
        </select>
      </div>

      <div class="row">
        <label>æ•¸é‡</label>
        <input id="qty" type="number" min="1" value="1" style="width:70px" />
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <input id="note" placeholder="ä¾‹:å°‘é†¬ã€ä¸è¦è”¥" />
      </div>

      <div class="center">
        <button id="addLunch">æ–°å¢è¨‚å–®ï¼ˆé€å‡ºåˆ°åœ˜ä¸»ï¼‰</button>
        <button id="backFromLunch" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <!-- Tea -->
  <div id="page-tea" class="hidden">
    <div class="row">
      <label for="teaRestaurant">é¤å»³åç¨±</label>
      <select id="teaRestaurant"></select>
    </div>

    <div class="menu-area">
      <div class="row">
        <label>å“é …</label>
        <select id="teaItem"></select>
      </div>

      <div class="row">
        <label>æ•¸é‡</label>
        <input id="teaQty" type="number" min="1" value="1" style="width:70px" />
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <input id="teaNote" placeholder="ä¾‹: é†¬å°‘ã€åŠ è¾£...." />
      </div>

      <div class="center">
        <button id="addTea">æ–°å¢ä¸‹åˆèŒ¶è¨‚å–®ï¼ˆé€å‡ºåˆ°åœ˜ä¸»ï¼‰</button>
        <button id="backFromTea" class="secondary">å›ä¸Šä¸€é </button>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div class="orders">
    <h3>æˆ‘çš„è¨‚å–®ï¼ˆå³æ™‚é¡¯ç¤ºï¼‰</h3>
    <div id="ordersList"></div>
    <p class="note">åƒ…é¡¯ç¤ºä½ æœ¬äººçš„è¨‚å–®ï¼Œå¯éš¨æ™‚åˆªé™¤ã€‚</p>
  </div>
</div>

<script>
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycby0dblq0ll4Hr9uNJbwui9YjnK4xO2c0pARxtNiXG9YZFwj-bsaVVI5ITaklYaK-R3e/exec";
let CURRENT_USER = null;
let MENUS = {};

const el = id => document.getElementById(id);
const restaurantSel = el("restaurant");
const menuItemSel = el("menuItem");
const potMainSel = el("potMain");
const teaRestaurantSel = document.getElementById("teaRestaurant");
const teaItemSel = document.getElementById("teaItem");

/* ========= åˆé¤ï¼šè¼‰å…¥ Menusï¼ˆåŒ…å«åˆ†é¡ï¼‰ ========= */
async function loadMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getMenus`);
    MENUS = await res.json();
  } catch (e) {
    console.error("fetch menus failed", e);
    MENUS = {};
  }

  restaurantSel.innerHTML = "";
  Object.keys(MENUS).forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    restaurantSel.appendChild(opt);
  });
  if (restaurantSel.options.length > 0) {
    restaurantSel.selectedIndex = 0;
  }
  populateMenu(restaurantSel.value);
}

function populateMenu(restaurant) {
  menuItemSel.innerHTML = "";
  const items = MENUS[restaurant] || [];
  let lastCat = null;

  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true;
      catOpt.textContent = it.cat;
      catOpt.style.fontWeight = "600";
      menuItemSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
    menuItemSel.appendChild(option);
  });

  const additionalRow = el("additionalRow");
  additionalRow.classList.add("hidden");
  potMainSel.innerHTML = "";

  // ä¸‰è‰²éºµç–™ç˜© â†’ é¡¯ç¤ºä¸»é£Ÿé¸é …
  if (restaurant.includes("ä¸‰è‰²éºµç–™ç˜©")) {
    showMainOptions();
  }
}

restaurantSel.addEventListener("change", () => {
  populateMenu(restaurantSel.value);
  el("qty").value = 1;
  el("note").value = "";
  el("spice").selectedIndex = 0;

  const additionalRow = el("additionalRow");
  additionalRow.classList.add("hidden");
  potMainSel.innerHTML = "";

  if (restaurantSel.value.includes("ä¸‰è‰²éºµç–™ç˜©")) {
    showMainOptions();
  }
});

menuItemSel.addEventListener("change", () => {
  const restaurant = restaurantSel.value;
  const additionalRow = el("additionalRow");

  if (restaurant.includes("ä¸‰è‰²éºµç–™ç˜©")) {
    showMainOptions();
  } else {
    additionalRow.classList.add("hidden");
  }
});

function showMainOptions() {
  const additionalRow = el("additionalRow");
  const label = additionalRow.querySelector("label");
  label.textContent = "ä¸»é£Ÿ";
  potMainSel.innerHTML = `
    <option>éºµç–™ç˜©</option>
    <option>æ„éºµ</option>
    <option>é›çµ²</option>
    <option>å†¬ç²‰</option>
    <option>æ³¡é£¯</option>
    <option>è’¸ç…®éºµ</option>
    <option>ç‹å­éºµ</option>
    <option>çƒé¾éºµ</option>
  `;
  additionalRow.classList.remove("hidden");
}

/* ========= ä¸‹åˆèŒ¶ï¼šè¼‰å…¥ Menu-teaï¼ˆåŒ…å«åˆ†é¡ï¼‰ ========= */
async function loadTeaMenus() {
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getTeaMenus`);
    const teaData = await res.json();

    // å­˜æˆå…¨åŸŸï¼Œåªçµ¦ä¸‹åˆèŒ¶ç”¨
    window.TEA_DATA = teaData;

    teaRestaurantSel.innerHTML = "";
    Object.keys(teaData).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      teaRestaurantSel.appendChild(opt);
    });

    if (teaRestaurantSel.options.length > 0) {
      teaRestaurantSel.selectedIndex = 0;
      populateTeaMenu(teaRestaurantSel.value);
    }
  } catch (e) {
    console.error("loadTeaMenus error:", e);
    alert("ä¸‹åˆèŒ¶èœå–®è¼‰å…¥å¤±æ•—");
  }
}

function populateTeaMenu(restaurant) {
  teaItemSel.innerHTML = "";

  const data = window.TEA_DATA || {};
  const items = data[restaurant] || [];
  let lastCat = null;

  items.forEach(it => {
    if (it.cat !== lastCat) {
      const catOpt = document.createElement("option");
      catOpt.disabled = true;
      catOpt.textContent = it.cat;
      catOpt.style.fontWeight = "600";
      teaItemSel.appendChild(catOpt);
      lastCat = it.cat;
    }
    const option = document.createElement("option");
    option.value = JSON.stringify(it);
    option.textContent = `${it.name} â€” ${it.price}å…ƒ`;
    teaItemSel.appendChild(option);
  });
}

teaRestaurantSel.addEventListener("change", () => {
  populateTeaMenu(teaRestaurantSel.value);
});

/* ========= ä¸‹åˆèŒ¶é€å–® ========= */
el("addTea").addEventListener("click", async () => {
  const date = new Date().toISOString().slice(0, 10);
  const itemObj = JSON.parse(teaItemSel.value || "{}");
  if (!itemObj.name) return alert("è«‹é¸æ“‡å“é …");

  const params = new URLSearchParams();
  params.append("date", date);
  params.append("employee", CURRENT_USER.name);
  params.append("restaurant", teaRestaurantSel.value);
  params.append("item", itemObj.name);
  params.append("price", itemObj.price || "");
  params.append("spice", "");   // ä¸‹åˆèŒ¶ä¸ä½¿ç”¨èª¿å‘³
  params.append("qty", document.getElementById("teaQty").value);
  params.append("note", document.getElementById("teaNote").value);
  params.append("potMain", "");

  try {
    await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    alert("ä¸‹åˆèŒ¶è¨‚å–®å·²æ–°å¢");
    renderOrders();
  } catch (e) {
    alert("æ–°å¢ä¸‹åˆèŒ¶å¤±æ•—");
  }
});

/* ========= ç™»å…¥ ========= */
el("btnLogin").addEventListener("click", async () => {
  const empId = el("empId").value.trim();
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getEmployees`);
    const employees = await res.json();
    const found = employees.find(e => String(e.id) === empId);
    if (found) {
      CURRENT_USER = found;
      el("page-login").classList.add("hidden");
      el("page-home").classList.remove("hidden");
      el("welcome").textContent = `æ­¡è¿ ${found.name}`;
      loadMenus();
      renderOrders();
    } else {
      alert("å·¥è™Ÿä¸å­˜åœ¨");
    }
  } catch (e) {
    alert("ç™»å…¥å¤±æ•—");
    console.error(e);
  }
});

/* ========= åˆé¤é€å–® ========= */
el("addLunch").addEventListener("click", async () => {
  const date = new Date().toISOString().slice(0, 10);
  const restaurant = restaurantSel.value;
  const itemObj = JSON.parse(menuItemSel.value || "{}");
  if (!itemObj.name) return alert("è«‹é¸æ“‡é¤é»");

  const params = new URLSearchParams();
  params.append("date", date);
  params.append("employee", CURRENT_USER.name);
  params.append("restaurant", restaurant);
  params.append("item", itemObj.name);
  params.append("price", itemObj.price || "");
  params.append("spice", el("spice").value);
  params.append("qty", el("qty").value);
  params.append("note", el("note").value);
  params.append("potMain", el("potMain").value || "");

  try {
    const res = await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
    });
    await res.json();
    alert("è¨‚å–®å·²æ–°å¢");
    renderOrders();
  } catch (e) {
    alert("æ–°å¢è¨‚å–®å¤±æ•—");
  }
});

/* ========= è¨‚å–®æ¸…å–® ========= */
async function renderOrders() {
  const ordersList = el("ordersList");
  if (!CURRENT_USER) return;
  try {
    const res = await fetch(`${GOOGLE_WEBAPP_URL}?action=getOrders&employee=${encodeURIComponent(CURRENT_USER.name)}`);
    const data = await res.json();
    ordersList.innerHTML = "";
    data.forEach((o, idx) => {
      const div = document.createElement("div");
      div.className = "order-item";
      div.innerHTML = `
        <strong>#${idx + 1} ${o.restaurant} - ${o.item}</strong>
        <div class="small">æ—¥æœŸ: ${o.date} | å“¡å·¥: ${o.employee} | æ•¸é‡: ${o.qty} | åƒ¹æ ¼: ${o.price} å…ƒ | èª¿å‘³: ${o.spice}</div>
        <div class="small">å‚™è¨»: ${o.note || ""} ${o.potMain ? " | ä¸»é£Ÿ: " + o.potMain : ""}</div>
        <button class="delete-btn" data-id="${o.id}">åˆªé™¤</button>
      `;
      ordersList.appendChild(div);
    });
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨‚å–®å—ï¼Ÿ")) {
          const params = new URLSearchParams();
          params.append("action", "delete");
          params.append("id", btn.dataset.id);
          params.append("employee", CURRENT_USER.name);
          await fetch(GOOGLE_WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params,
          });
          renderOrders();
        }
      });
    });
  } catch (e) {
    console.error("renderOrders error", e);
  }
}

/* ========= å°è¦½ ========= */
el("toLunch").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-lunch").classList.remove("hidden");
});
el("toTea").addEventListener("click", () => {
  el("page-home").classList.add("hidden");
  el("page-tea").classList.remove("hidden");
  loadTeaMenus();
});
el("backFromLunch").addEventListener("click", () => {
  el("page-lunch").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});
el("backFromTea").addEventListener("click", () => {
  el("page-tea").classList.add("hidden");
  el("page-home").classList.remove("hidden");
});
</script>
</body>
</html>
